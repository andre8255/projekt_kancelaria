@startuml
title Diagram czynności — Rejestracja Bierzmowania (start z profilu osoby)

start

:Użytkownik wchodzi w profil osoby;
:Klik "Dodaj bierzmowanie";

:System pobiera osobę (osoba_pk);

if (Czy osoba ma już bierzmowanie?) then (tak)
  :Komunikat "Ta osoba ma już wpis bierzmowania";
  :Powrót do profilu osoby;
  stop
endif

:System otwiera formularz bierzmowania;
:System ustawia pole osoba = wybrana osoba (ukryte/readonly);

:Użytkownik uzupełnia dane
(data, miejsce, imię bierzmowania,
rok/akt_nr, parafia, szafarz,
świadek, uwagi, skan);

:Klik "Zapisz";

:Walidacja formularza;

if (Brak parafii i brak parafii ręcznej?) then (tak)
  :Błąd: "Wybierz parafię z listy lub wpisz ręcznie";
  :Powrót do formularza;
  stop
endif

if (Brak roku i jest data bierzmowania?) then (tak)
  :Ustal rok = rok z daty bierzmowania;
endif

if (Brak roku i brak daty?) then (tak)
  :Błąd: "Podaj datę bierzmowania lub rok";
  :Powrót do formularza;
  stop
endif

:Ustal numer aktu (auto) / sprawdź poprawność;

if (Błąd numeru aktu?) then (tak)
  :Błąd przy polu akt_nr;
  :Powrót do formularza;
  stop
endif

if (Data bierzmowania w przyszłości?) then (tak)
  :Błąd przy polu data_bierzmowania;
  :Powrót do formularza;
  stop
endif

if (Czy jest data urodzenia i bierzmowanie przed urodzeniem?) then (tak)
  :Błąd przy polu data_bierzmowania;
  :Powrót do formularza;
  stop
endif

:Sprawdź chrzest osoby (jeśli istnieje);

if (Chrzest istnieje i bierzmowanie < chrzest?) then (tak)
  :Błąd: "Bierzmowanie nie może być wcześniejsze niż chrzest";
  :Powrót do formularza;
  stop
endif

:Zapis rekordu Bierzmowanie;

if (Wybrano parafię ze słownika?) then (tak)
  :parafia = wybrana;
  :parafia ręczna = pusta;
else (nie)
  :parafia = NULL;
  :parafia ręczna = wpisana;
endif

if (Wybrano szafarza ze słownika?) then (tak)
  :szafarz = wybrany;
  :szafarz ręczny = pusty;
else (nie)
  :szafarz = NULL;
  :szafarz ręczny = wpisany;
endif

if (Podano imię bierzmowania?) then (tak)
  :Aktualizuj imię bierzmowania w Osoba (jeśli inne);
endif

:Zapisz LogAkcji (DODANIE_BIERZMOWANIA);
:Komunikat sukcesu;

:Przekierowanie do profilu osoby;

stop
@enduml
