{% extends "base_panel.html" %}
{% block content %}

<style>
  .mini-cal { --gap: .5rem; }
  .mini-cal .week { display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--gap); }
  .mini-cal .day {
    position: relative; padding: .6rem .5rem; border-radius: .6rem;
    background: #fff; border: 1px solid #eef1f4; min-height: 80px;
    transition: transform .1s ease, box-shadow .1s ease, border-color .1s ease;
    display: flex; flex-direction: column; justify-content: space-between;
  }
  .mini-cal .day:hover {
    transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,.07);
    border-color: #e0e0e0;
  }
  .mini-cal .dm-muted { opacity: .5; background: #fdfdfd; }
  .mini-cal .dow { font-size: .72rem; letter-spacing: .02em; color: #6c757d; }
  .mini-cal .num { font-weight: 600; font-size: 0.85rem; }
  .mini-cal .today {
    background: #eef5ff; border-color: #aaccff; box-shadow: none;
  }
  .mini-cal .today .num { color: #0d6efd; font-weight: 700; }
  .mini-cal .day-status { display: flex; align-items: center; gap: .35rem; }
  .mini-cal .status-text { font-size: .7rem; font-weight: 500; color: #555; }
  .mini-cal .dot {
    width: .45rem; height: .45rem; border-radius: 50%; display: inline-block; vertical-align: middle;
  }
  .dot-free { background:#198754; } .dot-busy { background:#dc3545; }
  .legend { gap: .5rem; }
  .mini-cal a { text-decoration: none; color: inherit; }

  /* Dodatkowe style dla ładniejszych kafelków */
  .stat-card .icon-box {
    width: 50px; height: 50px;
    display: grid; place-items: center;
    border-radius: .75rem;
    font-size: 1.5rem;
  }
  .stat-card-osoby .icon-box { background-color: #e6f0ff; color: #0d6efd; }
  .stat-card-rodziny .icon-box { background-color: #e6f9f0; color: #198754; }
  .stat-card-chrzty .icon-box { background-color: #eef1f4; color: #495057; }
  .stat-card-bierzm .icon-box { background-color: #fff0e6; color: #fd7e14; }
  .stat-card-sluby .icon-box { background-color: #fde7ea; color: #dc3545; }


  /* Nowe style dla podświetlenia dni */
.mini-cal .day-free {
  background: #f6fef9; /* Bardzo jasny zielony */
}
.mini-cal .day-busy {
  background: #fef7f7; /* Bardzo jasny czerwony */
}

/* Poprawka, aby styl .today wygrywał z tłem */
.mini-cal .today.day-free,
.mini-cal .today.day-busy {
  background: linear-gradient(180deg, #f8fbff, #ffffff);
}

/* Poprawka, aby najechanie myszką zawsze dawało białe tło */
.mini-cal .day:hover {
  background: #fff;
  transform: translateY(-1px);
  box-shadow: 0 4px 18px rgba(0,0,0,.06);
}
</style>


{# MINI KALENDARZ #}
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <div class="fw-semibold">Kalendarz mszy – {{ mini_kalendarz.month_label }}</div>
    <div class="legend d-none d-sm-flex align-items-center">
      <span class="dot dot-free me-1"></span><span class="text-muted small me-3">wolna</span>
      <span class="dot dot-busy me-1"></span><span class="text-muted small">zajęta</span>
    </div>
  </div>

  <div class="card-body">
    <div class="mini-cal">
      {# Nagłówki dni (pn–nd) #}
      <div class="week mb-2">
      {% for dow in dni_tyg %}
    <div class="text-center dow">{{ dow }}</div>
      {% endfor %}
      </div>


      {# Tygodnie #}
      {% for week in mini_kalendarz.weeks %}
        <div class="week mb-2">
          {% for day in week %}
            {# link do listy mszy z filtrem daty #}
            <a class="day {% if day.is_other_month %}dm-muted{% endif %} {% if day.is_today %}today{% endif %} {% if day.all > day.busy %}day-free{% elif day.busy > 0 %}day-busy{% endif %}"
   href="{% url 'msza_lista' %}?data={{ day.date|date:'Y-m-d' }}"
   title="{% if day.all %}Msze: {{ day.all }}, zajęte: {{ day.busy }}{% else %}Brak mszy{% endif %}">
              <div class="d-flex justify-content-between align-items-start">
  <span class="num">{{ day.date.day }}</span>

  {# POPRAWIONA LOGIKA KROPKI #}
  {% if day.all > day.busy %}
    <span class="dot dot-free" aria-hidden="true"></span>
  {% elif day.busy > 0 %}
    <span class="dot dot-busy" aria-hidden="true"></span>
  {% endif %}
</div>

              {% if day.all %}
                <div class="chips">
                  <span class="chip chip-all">{{ day.all }} msz.</span>
                  {% if day.busy %}<span class="chip chip-busy">{{ day.busy }} zaj.</span>{% endif %}
                </div>
              {% else %}
                <div class="text-muted" style="font-size:.72rem; margin-top:.35rem;">—</div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% endfor %}
    </div>

    <div class="d-sm-none mt-2">
      <span class="dot dot-free me-1"></span><span class="text-muted small me-3">wolna</span>
      <span class="dot dot-busy me-1"></span><span class="text-muted small">zajęta</span>
    </div>
  </div>
</div>

<div class="row g-4">
  {# Najbliższe msze #}
  <div class="col-lg-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header bg-white fw-semibold">Najbliższe msze</div>
      <div class="card-body small">
        {% if msze_najblizsze %}
          <ul class="list-group list-group-flush">
            {% for m in msze_najblizsze %}
              <li class="list-group-item d-flex justify-content-between">
                <span>
                  {{ m.data }} {{ m.godzina }} — {{ m.miejsce|default:"—" }}
                  {% if m.intencje.exists %}<span class="badge bg-danger-subtle text-danger ms-1">zajęta</span>
                  {% else %}<span class="badge bg-success-subtle text-success ms-1">wolna</span>{% endif %}
                </span>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'msza_szczegoly' m.pk %}">Szczegóły</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Brak zaplanowanych mszy.</div>
        {% endif %}
      </div>
    </div>
  </div>

  {# Ostatnie wpisy #}
  <div class="col-lg-6">
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-header bg-white fw-semibold">Ostatnie chrzty</div>
      <div class="card-body small">
        {% if ostatnie_chrzty %}
          <ul class="list-group list-group-flush">
            {% for c in ostatnie_chrzty %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ c.rok }}/{{ c.akt_nr }} — {{ c.ochrzczony }}</span>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'chrzest_szczegoly' c.pk %}">Pokaż</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Brak wpisów.</div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm border-0">
      <div class="card-header bg-white fw-semibold">Ostatnie małżeństwa</div>
      <div class="card-body small">
        {% if ostatnie_sluby %}
          <ul class="list-group list-group-flush">
            {% for s in ostatnie_sluby %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ s.rok }}/{{ s.akt_nr|default:"—" }} — {{ s.malzonek_a.nazwisko_rodowe }} {{ s.malzonek_a.imie_pierwsze }} &amp; {{ s.malzonek_b.nazwisko_rodowe }} {{ s.malzonek_b.imie_pierwsze }}</span>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'malzenstwo_szczegoly' s.pk %}">Pokaż</a>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Brak wpisów.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{# --- TUTAJ ZOSTAL WKLEJONY NOWY KOD BACKUPU --- #}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-shield-lock-fill"></i> Bezpieczeństwo Danych
            </div>
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">Kopia Zapasowa (Backup)</h5>
                    <p class="card-text text-muted small">
                        Pobierz plik bazy danych i zapisz go na dysku zewnętrznym (pendrive).
                        Zalecane wykonywanie raz w tygodniu.
                    </p>
                </div>
                <a href="{% url 'konta:pobierz_backup' %}" class="btn btn-dark">
                    <i class="bi bi-download"></i> Pobierz kopię bazy
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}