{% extends "base_panel.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Lista Mszy ≈öwiƒôtych</h1>
  <div class="d-flex gap-2">

    {# Przycisk PDF (z zachowaniem filtr√≥w) #}
    <a href="{% url 'msza_lista_pdf' %}?{{ request.GET.urlencode }}" target="_blank" class="btn btn-outline-secondary btn-sm">
     üìÑ Pobierz listƒô (PDF)
    </a>


    {# Przycisk dodawania (odpowiednik "Edytuj" w kontek≈õcie zarzƒÖdzania listƒÖ) #}
    <a href="{% url 'msza_nowa' %}" class="btn btn-primary btn-sm">
      <i class="bi bi-plus-lg"></i> Nowa msza
    </a>
    
    
  </div>
</div>

{# --- FORMULARZ FILTROWANIA (Bez zmian) --- #}
<div class="card shadow-sm mb-4">
  <div class="card-body bg-light pt-3 pb-2">
    <form method="get" class="row g-2 align-items-end">
      
      <div class="col-auto">
        <label class="form-label small fw-bold mb-1">Data od:</label>
        <input type="date" name="data_od" class="form-control form-control-sm" value="{{ filtr_data_od }}">
      </div>

      <div class="col-auto">
        <label class="form-label small fw-bold mb-1">Data do:</label>
        <input type="date" name="data_do" class="form-control form-control-sm" value="{{ filtr_data_do }}">
      </div>

      <div class="col-auto">
        <label class="form-label small fw-bold mb-1">Rodzaj:</label>
        <select name="typ" class="form-select form-select-sm" style="min-width: 150px;">
          <option value="">-- Wszystkie --</option>
          {% for kod, nazwa in typy_mszy %}
            <option value="{{ kod }}" {% if filtr_typ == kod %}selected{% endif %}>{{ nazwa }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label small fw-bold mb-1">Status:</label>
        <select name="status" class="form-select form-select-sm">
          <option value="">-- Wszystkie --</option>
          <option value="wolna" {% if filtr_status == 'wolna' %}selected{% endif %}>Wolna</option>
          <option value="zajeta" {% if filtr_status == 'zajeta' %}selected{% endif %}>Zajƒôta</option>
        </select>
      </div>

      <div class="col-auto">
        <label class="form-label small fw-bold mb-1">Szukaj:</label>
        <input type="text" name="q" class="form-control form-control-sm" placeholder="Miejsce, celebrans..." value="{{ filtr_q }}">
      </div>

      <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="bi bi-search"></i> Filtruj
        </button>
        <a href="{% url 'msza_lista' %}" class="btn btn-sm btn-outline-secondary">
          Wyczy≈õƒá
        </a>
      </div>
    </form>
  </div>
</div>

{# --- TABELA WYNIK√ìW --- #}
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 text-sm">
        <thead class="table-light text-muted">
          <tr>
            <th>Data</th>
            <th>Godzina</th>
            <th>Rodzaj</th>
            <th>Miejsce</th>
            <th>Celebrans</th>
            <th>Intencje</th>
            <th class="text-end">Akcje</th>
          </tr>
        </thead>
        <tbody>
          {% for msza in msze %}
          <tr>
            <td class="fw-semibold text-nowrap">
              {{ msza.data|date:"d.m.Y" }} 
              <span class="text-muted fw-normal small">({{ msza.data|date:"D" }})</span>
            </td>
            
            <td>{{ msza.godzina|time:"H:i" }}</td>

            <td>
                {% if msza.typ == 'NIEDZIELNA' %}
                    <span class="badge text-bg-danger bg-opacity-10 text-danger border border-danger-subtle">Niedzielna</span>
                {% elif msza.typ == 'SLUBNA' %}
                    <span class="badge text-bg-warning bg-opacity-10 text-warning-emphasis border border-warning-subtle">≈ölub</span>
                {% elif msza.typ == 'POGRZEBOWA' %}
                    <span class="badge text-bg-dark border">Pogrzeb</span>
                {% else %}
                    <span class="badge text-bg-light border text-secondary">{{ msza.get_typ_display }}</span>
                {% endif %}
            </td>

            <td class="text-truncate" style="max-width: 150px;">{{ msza.miejsce }}</td>

            <td class="text-truncate" style="max-width: 150px;">
               {% if msza.celebrans %}
                 {{ msza.celebrans }}
               {% else %}
                 {{ msza.celebrans_opis|default:"‚Äî" }}
               {% endif %}
            </td>

            <td>
              {% if msza.zajeta %}
                 <span class="badge bg-success-subtle text-success border border-success-subtle">
                   {{ msza.intencje.count }} intencji
                 </span>
              {% else %}
                 <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle">
                   Wolna
                 </span>
              {% endif %}
            </td>

            <td class="text-end">
              <div class="btn-group btn-group-sm">
                
                {# --- ZMIANA: SZCZEG√ì≈ÅY --- #}
                <a href="{% url 'msza_szczegoly' msza.pk %}" class="btn btn-outline-secondary" title="Szczeg√≥≈Çy">
                  <i class="bi bi-eye"></i> Szczeg√≥≈Çy
                </a>
                
                {# --- ZMIANA: USU≈É (zamiast Edytuj) --- #}
                <a href="{% url 'msza_usun' msza.pk %}" class="btn btn-outline-danger" title="Usu≈Ñ">
                  <i class="bi bi-trash"></i> Usu≈Ñ
                </a>

              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center p-4 text-muted">
              Brak mszy spe≈ÇniajƒÖcych kryteria wyszukiwania.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {# Paginacja #}
  {% if is_paginated %}
  <div class="card-footer bg-white">
    <ul class="pagination pagination-sm justify-content-center mb-0">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">
            &laquo; Poprzednia
          </a>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">Strona {{ page_obj.number }} z {{ page_obj.paginator.num_pages }}</span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">
            Nastƒôpna &raquo;
          </a>
        </li>
      {% endif %}
    </ul>
  </div>
  {% endif %}
</div>
{% endblock %}