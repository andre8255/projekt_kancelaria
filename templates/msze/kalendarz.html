{% extends "base_panel.html" %}
{% load static %}

{% block content %}
<div class="card shadow-sm border-0">
  <div class="card-body p-3">
    <div id="kalendarz"></div>
  </div>
</div>

<link href="{% static 'vendor/fullcalendar/index.global.min.css' %}" rel="stylesheet">
<script src="{% static 'vendor/fullcalendar/index.global.min.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const el = document.getElementById("kalendarz");

  const kalendarz = new FullCalendar.Calendar(el, {
    themeSystem: 'bootstrap5',
    initialView: window.innerWidth < 768 ? 'listWeek' : 'timeGridWeek',
    locale: 'pl',
    nowIndicator: true,
    
    // Formatowanie godziny (np. 07:00)
    eventTimeFormat: {
      hour: '2-digit',
      minute: '2-digit',
      meridiem: false,
      hour12: false
    },

    // Nagłówek i przyciski
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dodajMsze,listaMszy dayGridMonth,timeGridWeek,timeGridDay'
    },
    customButtons: {
      dodajMsze: {
        text: '+ Dodaj mszę',
        click: function() { window.location.href = "{% url 'msza_nowa' %}"; }
      },
      listaMszy: {
        text: 'Lista',
        click: function() { window.location.href = "{% url 'msza_lista' %}"; }
      }
    },
    buttonText: {
      today: 'Dziś', month: 'Miesiąc', week: 'Tydzień', day: 'Dzień', list: 'Lista'
    },

    // Pobieranie danych
    events: {
      url: "{% url 'msza_kalendarz_dane' %}",
      method: "GET",
    },

    // --- NOWOŚĆ: Kliknięcie w puste miejsce (dodawanie mszy) ---
    dateClick: function(info) {
      // Używamy encodeURIComponent, aby znak '+' w dacie (strefa czasowa) 
      // został poprawnie przekazany w URL (jako %2B, a nie spacja).
      var url = "{% url 'msza_nowa' %}" + "?data=" + encodeURIComponent(info.dateStr);
      
      window.location.href = url;
    },
    // -----------------------------------------------------------

    // Kliknięcie w istniejącą mszę (edycja/szczegóły)
    eventClick: function(info) {
      info.jsEvent.preventDefault();
      if (info.event.url) {
        window.location.href = info.event.url;
      }
    },

    // Kłódki (zajęte/wolne)
    eventDidMount: function(info) {
      const titleEl = info.el.querySelector('.fc-event-title');
      if (!titleEl) return; 
      if (info.event.extendedProps.isBusy) { 
         titleEl.innerHTML = '<i class="bi bi-lock-fill me-1"></i>' + info.event.title;
      } else {
         titleEl.innerHTML = '<i class="bi bi-unlock-fill me-1"></i>' + info.event.title;
      }
    },
  });
  
  kalendarz.render();

  // Stylowanie przycisków (opcjonalne)
  const dodajBtn = el.querySelector('.fc-dodajMsze-button');
  if (dodajBtn) {
    dodajBtn.classList.remove('btn-secondary');
    dodajBtn.classList.add('btn-primary');
  }
});
</script>
{% endblock %}