{% extends "base_panel.html" %}

{% block content %}
<div class="card shadow-sm border-0">
  <div class="card-body p-3">
    <div id="kalendarz"></div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const el = document.getElementById("kalendarz");

  const kalendarz = new FullCalendar.Calendar(el, {
    // Motyw Bootstrap 5
    themeSystem: 'bootstrap5',

    // Widok responsywny
    initialView: window.innerWidth < 768 ? 'listWeek' : 'timeGridWeek',

    // Własne przyciski
    customButtons: {
      dodajMsze: {
        text: '+ Dodaj mszę',
        click: function() {
          window.location.href = "{% url 'msza_nowa' %}";
        }
      },
      listaMszy: {
        text: 'Lista mszy',
        click: function() {
          window.location.href = "{% url 'msza_lista' %}";
        }
      }
    },

    // Pasek narzędzi
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dodajMsze,listaMszy dayGridMonth,timeGridWeek,timeGridDay,listWeek'
    },
    
    buttonText: {
      today: 'Dziś', month: 'Miesiąc', week:  'Tydzień', day: 'Dzień', list: 'Lista'
    },
    
    height: 'auto', 
    
    // --- Reszta Twoich ustawień ---
    slotMinTime: "06:00:00",
    slotMaxTime: "22:00:00",
    allDaySlot: false,
    firstDay: 1,
    locale: 'pl',
    nowIndicator: true,

    events: {
      url: "{% url 'msza_kalendarz_dane' %}",
      method: "GET",
    },

    eventClick: function(info) {
      info.jsEvent.preventDefault();
      if (info.event.url) {
        window.location.href = info.event.url;
      }
    },

    eventDidMount: function(info) {
      const titleEl = info.el.querySelector('.fc-event-title');
      if (!titleEl) return; 

      if (info.event.extendedProps.isBusy) { 
         titleEl.innerHTML = 
           '<i class="bi bi-lock-fill me-1" style="font-size: .8em;"></i>' + info.event.title;
      } else {
         titleEl.innerHTML = 
           '<i class="bi bi-unlock-fill me-1" style="font-size: .8em;"></i>' + info.event.title;
      }
    },
    
    // --- ⬇️ NOWO DODANY BLOK KODU ⬇️ ---
    dateClick: function(info) {
      // info.dateStr zawiera datę i godzinę klikniętego slotu
      // np. "2025-11-15T10:30:00+01:00"
      
      // Budujemy URL do formularza nowej mszy, dodając datę jako parametr GET
      // np. /.../msza/nowa/?data=2025-11-15T10:30:00+01:00
      var url = "{% url 'msza_nowa' %}" + "?data=" + info.dateStr;
      
      // Przekierowujemy użytkownika
      window.location.href = url;
    }
    // --- ⬆️ KONIEC NOWEGO BLOKU ⬆️ ---

  });
  
  kalendarz.render();

  // Kod do stylowania przycisku (bez zmian)
  const dodajBtn = el.querySelector('.fc-dodajMsze-button');
  if (dodajBtn) {
    dodajBtn.classList.remove('btn-secondary');
    dodajBtn.classList.add('btn-primary');
  }
});
</script>
{% endblock %}